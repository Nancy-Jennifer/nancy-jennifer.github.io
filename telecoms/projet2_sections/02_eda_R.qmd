---
title: "Exploration des données – QoS mobile 2024"
subtitle: "Voix & Internet mobile – France métropolitaine et benchmark international"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: false
execute:
  echo: false
  warning: false
  message: false
---

```{r setup, include=FALSE}
needed_packages <- c(
  "dplyr", "tidyr", "readr", "janitor",
  "ggplot2", "scales", "stringr", "purrr", "tibble"
)

missing_pkgs <- needed_packages[!sapply(needed_packages, requireNamespace, quietly = TRUE)]

if (length(missing_pkgs) > 0) {
  install.packages(missing_pkgs, repos = "https://cloud.r-project.org")
}

suppressPackageStartupMessages({
  lapply(needed_pkgs, library, character.only = TRUE)
})

knitr::opts_chunk$set(
  echo    = FALSE,
  message = FALSE,
  warning = FALSE
)

theme_set(
  theme_minimal(base_size = 12) +
    theme(
      plot.title      = element_text(face = "bold"),
      plot.subtitle   = element_text(colour = "grey40"),
      legend.position = "bottom"
    )
)

# 02_eda_R.qmd est dans "telecoms/projet2_sections"
base_dir <- "../.."
operateurs_levels <- c("Orange", "SFR", "Bouygues", "Free")
```

## 1. Contexte et périmètre

Ce rapport explore la qualité de service mobile 2024 en France métropolitaine sur deux volets :

- **Voix** : capacité du réseau à établir des appels de manière fiable, sans coupure ni perturbation audible ;
- **Data** : confort d’usage internet (pages qui se chargent rapidement, débits suffisants).

Les mesures issues de l’**ARCEP** sont complétées par des données **UIT / Banque mondiale** pour positionner la France par rapport aux standards internationaux.

Les questions clés :

- Où chaque opérateur est-il **structurellement fort** ou en retrait, en Voix et en Data ?
- Quelles **zones** (habitations, transports…) constituent des **zones à risque** pour l’expérience client ?
- Comment la France se situe-t-elle par rapport à des pays comparables en termes d’usage, de couverture et de débits ?

```{r load-data, include=FALSE}
# ARCEP France
globaux_clean <- readr::read_csv(
  file.path(base_dir, "data", "processed", "arcep_2024_indicateurs_globaux_clean.csv")
) |>
  janitor::clean_names()

voix_hab <- readr::read_csv(
  file.path(base_dir, "data", "processed", "2024_QoS_Metropole_voix_habitations_clean.csv")
) |>
  janitor::clean_names()

voix_trans <- readr::read_csv(
  file.path(base_dir, "data", "processed", "2024_QoS_Metropole_voix_transports_clean.csv")
) |>
  janitor::clean_names()

data_hab <- readr::read_csv(
  file.path(base_dir, "data", "processed", "2024_QoS_Metropole_data_habitations_clean.csv")
) |>
  janitor::clean_names()

data_trans <- readr::read_csv(
  file.path(base_dir, "data", "processed", "2024_QoS_Metropole_data_transports_clean.csv.gz.zip")
) |>
  janitor::clean_names()

# ITU / WB
itu_final <- readr::read_csv(
  file.path(base_dir, "data", "clean_final", "ITU_FactsFigures2024_final_clean.csv")
) |>
  janitor::clean_names()

itu_summary <- readr::read_csv(
  file.path(base_dir, "data", "clean_final", "ITU_FactsFigures2024_summary_clean.csv")
) |>
  janitor::clean_names()

# Harmonisation colonnes ITU (robuste)
nms <- names(itu_summary)

if (!"indicateur" %in% nms) {
  if ("indicator" %in% nms) {
    itu_summary <- dplyr::rename(itu_summary, indicateur = indicator)
  } else if ("indicator_code" %in% nms) {
    itu_summary <- dplyr::rename(itu_summary, indicateur = indicator_code)
  }
}

if (!"pays" %in% names(itu_summary) && "country" %in% names(itu_summary)) {
  itu_summary <- dplyr::rename(itu_summary, pays = country)
}

if (!"annee" %in% names(itu_summary) && "year" %in% names(itu_summary)) {
  itu_summary <- dplyr::rename(itu_summary, annee = year)
}

if (!"valeur" %in% names(itu_summary) && "value" %in% names(itu_summary)) {
  itu_summary <- dplyr::rename(itu_summary, valeur = value)
}

standardiser_operateur <- function(df) {
  if (!"operator" %in% names(df)) return(df)
  df |>
    dplyr::mutate(
      operator = stringr::str_to_title(operator),
      operator = dplyr::recode(operator,
                               "Bouygues Telecom" = "Bouygues"),
      operator = factor(operator, levels = operateurs_levels)
    )
}

voix_hab   <- standardiser_operateur(voix_hab)
voix_trans <- standardiser_operateur(voix_trans)
data_hab   <- standardiser_operateur(data_hab)
data_trans <- standardiser_operateur(data_trans)
```

---

## 2. Voix – fiabilité des appels

### 2.1 Construction du score Voix

```{r voix-kpi, include=FALSE}
voix_all <- dplyr::bind_rows(
  voix_hab   |> dplyr::mutate(context = "Habitations"),
  voix_trans |> dplyr::mutate(context = "Transports")
)

voix_all <- voix_all |>
  dplyr::mutate(
    zone = if ("zone" %in% names(voix_all)) zone else "inconnue",
    zone = factor(zone)
  )

voix_kpi_base <- voix_all |>
  dplyr::filter(!is.na(crspa)) |>
  dplyr::group_by(operator, zone, context) |>
  dplyr::summarise(
    taux_appels_reussis = mean(crspa == 1, na.rm = TRUE),
    n                   = dplyr::n(),
    .groups             = "drop"
  )

voix_kpi_rescale <- voix_kpi_base |>
  dplyr::mutate(score_voix_100 = 100 * taux_appels_reussis)

kpi_voix_synthese_operateur <- voix_kpi_rescale |>
  dplyr::group_by(operator) |>
  dplyr::summarise(
    score_voix_moyen = stats::weighted.mean(score_voix_100, w = n, na.rm = TRUE),
    n_total          = sum(n),
    .groups          = "drop"
  ) |>
  dplyr::arrange(dplyr::desc(score_voix_moyen))
```

```{r voix-table-operateur}
knitr::kable(
  kpi_voix_synthese_operateur,
  caption = "Score voix moyen global par opérateur (pondéré par le nombre de mesures).",
  digits = 1
)
```

**Lecture :**

- Score voix **0–100** pondéré par le volume de mesures.  
- Vue synthétique du **classement global** des opérateurs sur la fiabilité des appels.

### 2.2 Comparaison par opérateur et environnement

```{r voix-comparaison, fig.cap="Score voix (0–100) par opérateur, type de zone et contexte (habitations vs transports)."}
ggplot2::ggplot(voix_kpi_rescale,
       ggplot2::aes(x = operator, y = score_voix_100, fill = operator)) +
  ggplot2::geom_col() +
  ggplot2::facet_grid(context ~ zone) +
  ggplot2::scale_y_continuous(labels = scales::label_number(accuracy = 1)) +
  ggplot2::labs(
    title    = "Voix – score d'appels réussis (0–100)",
    subtitle = "Lecture croisée opérateur × zone × contexte",
    x        = NULL,
    y        = "Score voix (0–100)"
  ) +
  ggplot2::guides(fill = "none")
```

**Insights clés :**

- Les **transports** sont en général plus exigeants que les lieux de vie.  
- Certains opérateurs sont **homogènes** entre zones, d’autres présentent des **écarts marqués**.

### 2.3 Zones à risque Voix

```{r voix-anomalies, include=FALSE}
voix_anomalies <- voix_kpi_rescale |>
  dplyr::filter(score_voix_100 < 95) |>
  dplyr::arrange(score_voix_100)

voix_zones_risque_v2 <- voix_anomalies |>
  dplyr::mutate(
    severite = dplyr::case_when(
      score_voix_100 < 90 ~ "Critique",
      score_voix_100 < 95 ~ "Sensible",
      TRUE                ~ "Acceptable"
    )
  )
```

```{r voix-visu-zones-risque, fig.cap="Zones où le score voix est inférieur à 95/100, classées par opérateur, contexte et type de zone."}
ggplot2::ggplot(voix_zones_risque_v2,
       ggplot2::aes(x = operator, y = score_voix_100, fill = operator)) +
  ggplot2::geom_col() +
  ggplot2::facet_grid(context ~ zone) +
  ggplot2::scale_y_continuous(labels = scales::label_number(accuracy = 1)) +
  ggplot2::labs(
    title    = "Voix – zones à risque (scores < 95)",
    subtitle = "Par opérateur, zone et contexte",
    x        = NULL,
    y        = "Score voix (0–100)"
  ) +
  ggplot2::guides(fill = "none")
```

**Insights & actions :**

- < 90 : zones **critiques**, risque fort de réclamations.  
- 90–95 : zones **sensibles**, à sécuriser dans un plan d’amélioration à 6–12 mois.

---

## 3. Data – confort d’usage internet mobile

### 3.1 KPI Data par opérateur

```{r data-kpi, include=FALSE}
data_all <- dplyr::bind_rows(
  data_hab   |> dplyr::mutate(context = "Habitations"),
  data_trans |> dplyr::mutate(context = "Transports")
)

data_kpi_prov_operateur <- data_all |>
  dplyr::group_by(context, operator) |>
  dplyr::summarise(
    part_pages_10s = mean(loaded_in_less_10_secondes == 1, na.rm = TRUE),
    debit_dl_med   = stats::median(bitrate_dl, na.rm = TRUE),
    n              = dplyr::n(),
    .groups        = "drop"
  )
```

```{r data-table-operateur}
knitr::kable(
  data_kpi_prov_operateur,
  caption = "Performance Data par opérateur et contexte : part des pages < 10 s et débit descendant médian.",
  digits = 2
)
```

```{r data_kpi_plot, fig.cap="Part des pages chargées en moins de 10 s par opérateur, séparée selon le contexte (habitations vs transports)."}
ggplot2::ggplot(data_kpi_prov_operateur,
       ggplot2::aes(x = operator, y = part_pages_10s, fill = operator)) +
  ggplot2::geom_col() +
  ggplot2::facet_wrap(~ context) +
  ggplot2::scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +
  ggplot2::labs(
    title    = "Internet mobile – pages chargées en moins de 10 s",
    subtitle = "Par opérateur et par contexte",
    x        = NULL,
    y        = "Part des pages < 10 s"
  ) +
  ggplot2::guides(fill = "none")
```

### 3.2 Performance par zone (si disponible)

```{r data-env, include=FALSE}
if ("zone" %in% colnames(data_all)) {
  data_env_probe_map_v2 <- data_all |>
    dplyr::group_by(context, operator, zone) |>
    dplyr::summarise(
      part_pages_10s = mean(loaded_in_less_10_secondes == 1, na.rm = TRUE),
      debit_dl_med   = stats::median(bitrate_dl, na.rm = TRUE),
      n              = dplyr::n(),
      .groups        = "drop"
    )
} else {
  data_env_probe_map_v2 <- NULL
}
```

```{r data-env-plot, eval = exists("data_env_probe_map_v2") && !is.null(data_env_probe_map_v2), fig.cap="Performance internet mobile par zone, opérateur et contexte (si la granularité zone est disponible)."}
ggplot2::ggplot(data_env_probe_map_v2,
       ggplot2::aes(x = zone, y = part_pages_10s, colour = operator, group = operator)) +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::facet_wrap(~ context) +
  ggplot2::scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +
  ggplot2::labs(
    title    = "Internet mobile – performance par zone",
    subtitle = "Lecture par opérateur et par contexte",
    x        = "Zone",
    y        = "Part des pages < 10 s"
  )
```

---

## 4. Benchmark international – position de la France

### 4.1 Usage d’internet & abonnements mobiles

```{r itu-usage, include=FALSE}
# Initialisation défensive
internet_use         <- NULL
mobile_ownership     <- NULL
internet_use_commune <- NULL
annee_ref            <- NA_real_

if (exists("itu_summary") &&
    all(c("indicateur", "annee", "valeur") %in% names(itu_summary))) {

  tmp_internet <- itu_summary |>
    dplyr::filter(indicateur == "internet_use_pct")

  tmp_mobile <- itu_summary |>
    dplyr::filter(indicateur == "mobile_subscriptions_100")

  if (nrow(tmp_internet) > 0 && "annee" %in% names(tmp_internet)) {
    annee_ref <- max(tmp_internet$annee, na.rm = TRUE)

    if (is.finite(annee_ref)) {
      internet_use_commune <- tmp_internet |>
        dplyr::filter(annee == annee_ref)
    } else {
      internet_use_commune <- tibble::tibble()
    }
  } else {
    internet_use_commune <- tibble::tibble()
  }

  internet_use     <- tmp_internet
  mobile_ownership <- tmp_mobile
} else {
  # Si la structure attendue n'est pas là, on met des tibbles vides
  internet_use         <- tibble::tibble()
  mobile_ownership     <- tibble::tibble()
  internet_use_commune <- tibble::tibble()
  annee_ref            <- NA_real_
}
```

```{r internet-use-plot, eval = !is.null(internet_use_commune) && nrow(internet_use_commune) > 0, fig.cap="Usage d’internet : France comparée aux moyennes régionales (année de référence)."}
internet_use_plot <- internet_use_commune |>
  dplyr::group_by(region) |>
  dplyr::summarise(
    internet_use_moy = mean(valeur, na.rm = TRUE),
    .groups           = "drop"
  )

fr_internet_use <- internet_use_commune |>
  dplyr::filter(pays == "France")

ggplot2::ggplot(internet_use_plot,
       ggplot2::aes(x = region, y = internet_use_moy)) +
  ggplot2::geom_col(alpha = 0.5) +
  ggplot2::geom_point(data = fr_internet_use,
             ggplot2::aes(x = region, y = valeur),
             size = 3) +
  ggplot2::labs(
    title    = "Usage d'internet – France vs régions",
    subtitle = if (is.finite(annee_ref)) paste("Année", annee_ref) else "Année non disponible",
    x        = NULL,
    y        = "Usage d'internet (%)"
  )
```

### 4.2 Mobile broadband & bande passante

```{r itu-broadband, include=FALSE}
mobile_broadband      <- NULL
mobile_broadband_strict <- NULL
annee_ref_mb          <- NA_real_

if (exists("itu_summary") &&
    all(c("indicateur", "annee", "valeur", "pays") %in% names(itu_summary))) {

  mobile_broadband <- itu_summary |>
    dplyr::filter(indicateur == "mobile_broadband_100")

  if (nrow(mobile_broadband) > 0) {
    annee_ref_mb <- max(mobile_broadband$annee, na.rm = TRUE)

    if (is.finite(annee_ref_mb)) {
      mobile_broadband_strict <- mobile_broadband |>
        dplyr::filter(annee == annee_ref_mb)
    } else {
      mobile_broadband_strict <- tibble::tibble()
    }
  } else {
    mobile_broadband_strict <- tibble::tibble()
  }
} else {
  mobile_broadband       <- tibble::tibble()
  mobile_broadband_strict <- tibble::tibble()
  annee_ref_mb           <- NA_real_
}
```

```{r broadband-plot, eval = !is.null(mobile_broadband_strict) && nrow(mobile_broadband_strict) > 0, fig.cap="Abonnements mobile broadband pour 100 habitants – position de la France dans le classement mondial."}
ggplot2::ggplot(mobile_broadband_strict,
       ggplot2::aes(x = reorder(pays, valeur), y = valeur)) +
  ggplot2::geom_col() +
  ggplot2::coord_flip() +
  ggplot2::labs(
    title    = "Abonnements mobile broadband – classement mondial",
    subtitle = if (is.finite(annee_ref_mb)) paste("Année", annee_ref_mb) else "Année non disponible",
    x        = NULL,
    y        = "Abonnements pour 100 habitants"
  )
```

```{r itu-bandwidth, include=FALSE}
avg_bandwidth      <- NULL
avg_bandwidth_synth <- NULL

if (exists("itu_summary") &&
    all(c("indicateur", "valeur", "region") %in% names(itu_summary))) {

  avg_bandwidth <- itu_summary |>
    dplyr::filter(indicateur == "avg_download_speed_mbps")

  if (nrow(avg_bandwidth) > 0) {
    avg_bandwidth_synth <- avg_bandwidth |>
      dplyr::group_by(region) |>
      dplyr::summarise(
        bw_moy  = mean(valeur, na.rm = TRUE),
        .groups = "drop"
      )
  } else {
    avg_bandwidth_synth <- tibble::tibble()
  }
} else {
  avg_bandwidth       <- tibble::tibble()
  avg_bandwidth_synth <- tibble::tibble()
}
```

```{r bandwidth-plot, eval = !is.null(avg_bandwidth_synth) && nrow(avg_bandwidth_synth) > 0, fig.cap="Bande passante moyenne par région (données UIT)."}
ggplot2::ggplot(avg_bandwidth_synth,
       ggplot2::aes(x = region, y = bw_moy)) +
  ggplot2::geom_col() +
  ggplot2::labs(
    title = "Bande passante moyenne par région",
    x     = NULL,
    y     = "Débit descendant moyen (Mbit/s)"
  )
```

---

## 5. Gap analysis – France vs moyennes régionales

```{r gap-build, include=FALSE}
gap_fr            <- NULL
index_sensitivity <- NULL
gap_consolidation <- NULL
gap_verdicts      <- NULL

if (exists("itu_summary") &&
    all(c("indicateur", "region", "valeur", "pays") %in% names(itu_summary))) {

  key_indics <- c("internet_use_pct", "mobile_broadband_100", "avg_download_speed_mbps")

  tmp <- itu_summary |>
    dplyr::filter(indicateur %in% key_indics)

  if (nrow(tmp) > 0) {
    gap_fr <- tmp |>
      dplyr::group_by(region, indicateur) |>
      dplyr::summarise(
        moy_region = mean(valeur, na.rm = TRUE),
        .groups    = "drop"
      ) |>
      dplyr::left_join(
        tmp |>
          dplyr::filter(pays == "France") |>
          dplyr::select(region, indicateur, valeur_fr = valeur),
        by = c("region", "indicateur")
      ) |>
      dplyr::mutate(
        gap = valeur_fr - moy_region
      )

    index_sensitivity <- gap_fr |>
      dplyr::group_by(indicateur) |>
      dplyr::mutate(
        gap_norm = (gap - min(gap, na.rm = TRUE)) /
                   (max(gap, na.rm = TRUE) - min(gap, na.rm = TRUE))
      ) |>
      dplyr::ungroup()

    gap_consolidation <- index_sensitivity |>
      dplyr::group_by(indicateur) |>
      dplyr::summarise(
        index_gap = mean(gap_norm, na.rm = TRUE),
        .groups    = "drop"
      )

    gap_verdicts <- gap_consolidation |>
      dplyr::mutate(
        verdict = dplyr::case_when(
          index_gap > 0.6 ~ "France en avance",
          index_gap < 0.4 ~ "France en retard",
          TRUE            ~ "France dans la moyenne"
        )
      )
  } else {
    gap_verdicts <- tibble::tibble()
  }

} else {
  gap_verdicts <- tibble::tibble()
}
```

```{r gap-table, eval = !is.null(gap_verdicts) && nrow(gap_verdicts) > 0}
knitr::kable(
  gap_verdicts,
  caption = "Gap analysis – synthèse du positionnement de la France par indicateur clé.",
  digits = 2
)
```

---

## 6. Synthèse pour décideurs

- **Voix** : scores élevés mais avec des **zones à risque** identifiées, à traiter dans des plans d’amélioration priorisés.  
- **Data** : différenciation plus nette entre opérateurs sur la **fluidité de navigation**.  
- **International** : position contrastée selon les indicateurs (usage, broadband, bande passante), justifiant une **gap analysis structurée**.  

Ces éléments peuvent alimenter des décisions **réseau**, **marketing** et **régulation** sur un horizon 12–24 mois.
