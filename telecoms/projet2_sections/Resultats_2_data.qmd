---
title: "Résultats – Data (Internet mobile)"
subtitle: "Médianes p50 — DL / UL / RSRP"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: false
    code-fold: show
execute:
  echo: true
  warning: false
  message: false
---

## Résultats DATA – p50 essentiels

```{r setup-p50, echo=FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages({
  library(dplyr); library(ggplot2); library(forcats)
})

# --- garde-fous : ne jamais casser le knit
has_dsn <- exists("data_scored_norm") && is.data.frame(data_scored_norm)

# Fonctions utilitaires minimalistes
to_lower_chr <- function(x) { tolower(as.character(x)) }
nz <- function(x, alt) { if(length(x)==0 || is.na(x)) alt else x }

# Préparation très tolérante
if (has_dsn) {
  dsn <- data_scored_norm
  nm  <- names(dsn)

  must_have <- all(c("operateur","lieu_strate","indicateur","kpi","valeur") %in% nm)
  if (!must_have) {
    # on fabrique un df vide pour que les chunks suivants restent sûrs
    df <- data.frame(operateur=character(), env=character(),
                     famille=character(), valeur=numeric(), stringsAsFactors = FALSE)
    env_top <- "indéterminé"
  } else {
    df0 <- dsn %>%
      mutate(
        operateur = tools::toTitleCase(to_lower_chr(operateur)),
        env_raw   = as.character(lieu_strate),
        indic_l   = to_lower_chr(indicateur),
        kpi_l     = to_lower_chr(kpi),
        valeur    = suppressWarnings(as.numeric(valeur)),
        famille   = dplyr::case_when(
          grepl("download|descend|down|throughput|speed|\\bdl\\b", indic_l) |
          grepl("download|descend|down|throughput|speed|\\bdl\\b", kpi_l) ~ "dl",
          grepl("upload|montant|uplink|\\bul\\b|\\bup\\b", indic_l) |
          grepl("upload|montant|uplink|\\bul\\b|\\bup\\b", kpi_l)         ~ "ul",
          grepl("^rsrp$", indic_l) | grepl("^rsrp$", kpi_l)               ~ "rsrp",
          TRUE ~ NA_character_
        ),
        env = ifelse(is.na(env_raw) | env_raw=="", "inconnu", env_raw)
      ) %>%
      filter(!is.na(famille))

    # Environnement le plus représenté (hors "inconnu" si possible)
    env_counts <- df0 %>% count(env, sort = TRUE)
    env_top <- if (nrow(env_counts)) {
      cand <- env_counts %>% filter(env != "inconnu") %>% slice(1) %>% pull(env)
      if (length(cand)==0) env_counts$env[1] else cand
    } else "indéterminé"

    df <- df0 %>% filter(env == env_top)
  }
} else {
  df <- data.frame(operateur=character(), env=character(),
                   famille=character(), valeur=numeric(), stringsAsFactors = FALSE)
  env_top <- "indéterminé"
}

# Agrégations p50 par famille (avec n)
agg_p50 <- function(d, fam) {
  d %>%
    filter(famille == fam, is.finite(valeur)) %>%
    group_by(operateur) %>%
    summarise(p50 = suppressWarnings(stats::median(valeur, na.rm=TRUE)),
              n   = sum(!is.na(valeur)), .groups="drop")
}

dl_tbl   <- agg_p50(df, "dl")
ul_tbl   <- agg_p50(df, "ul")
rsrp_tbl <- agg_p50(df, "rsrp")

# Ordre opérateurs = DL décroissant si dispo
if (nrow(dl_tbl)) {
  ord_ops <- dl_tbl %>% arrange(desc(p50)) %>% pull(operateur)
} else {
  ord_ops <- sort(unique(df$operateur))
}
reord <- function(t) if (nrow(t)) t %>% mutate(operateur = factor(operateur, levels = ord_ops)) else t
dl_tbl   <- reord(dl_tbl)
ul_tbl   <- reord(ul_tbl)
rsrp_tbl <- reord(rsrp_tbl)

# Thème
theme_set(theme_minimal(base_size = 13))
```

### Débit descendant — p50
```{r plot-dl, fig.width=8, fig.height=4.4}
if (!nrow(dl_tbl)) {
  ggplot() + theme_void() +
    annotate("text", x=0, y=0, label="Aucune donnée DL détectée pour l’environnement sélectionné.", size=4) +
    labs(subtitle = paste("Environnement :", env_top))
} else {
  ggplot(dl_tbl, aes(operateur, p50)) +
    geom_col() +
    geom_text(aes(label = paste0(round(p50,1)," Mb/s (n=", n, ")")), vjust=-0.25, size=3.5) +
    labs(title="Débit descendant — médiane p50",
         subtitle=paste("Environnement :", env_top),
         x=NULL, y="Mb/s")
}
```

**Lecture rapide – DL (p50).**  
La médiane du débit descendant reflète la fluidité perçue (web, vidéo, apps). Les écarts entre opérateurs indiquent des différences de capacité radio/backhaul sur la zone **`r env_top`**. Priorité : consolider les bas de classement sur les axes à trafic fort.

### Débit montant — p50
```{r plot-ul, fig.width=8, fig.height=4.4}
if (!nrow(ul_tbl)) {
  ggplot() + theme_void() +
    annotate("text", x=0, y=0, label="Aucune donnée UL détectée pour l’environnement sélectionné.", size=4) +
    labs(subtitle = paste("Environnement :", env_top))
} else {
  ggplot(ul_tbl, aes(operateur, p50)) +
    geom_col() +
    geom_text(aes(label = paste0(round(p50,1)," Mb/s (n=", n, ")")), vjust=-0.25, size=3.5) +
    labs(title="Débit montant — médiane p50",
         subtitle=paste("Environnement :", env_top),
         x=NULL, y="Mb/s")
}
```

**Lecture rapide – UL (p50).**  
Le débit montant médian impacte l’envoi de médias, le cloud et les messageries. Des valeurs faibles brident fortement l’expérience WhatsApp/Drive. Cibler les cellules sous-performantes sur **`r env_top`** améliore nettement l’usage social.

### RSRP — p50
```{r plot-rsrp, fig.width=8, fig.height=4.4}
if (!nrow(rsrp_tbl)) {
  ggplot() + theme_void() +
    annotate("text", x=0, y=0, label="Aucune donnée RSRP détectée pour l’environnement sélectionné.", size=4) +
    labs(subtitle = paste("Environnement :", env_top))
} else {
  ggplot(rsrp_tbl, aes(operateur, p50)) +
    geom_col() +
    geom_hline(yintercept=-100, linetype="dashed") +
    geom_text(aes(label = paste0(round(p50,0)," dBm (n=", n, ")")), vjust=-0.25, size=3.5) +
    labs(title="RSRP — médiane p50",
         subtitle=paste("Environnement :", env_top, "— repère confort 4G ≈ −100 dBm (pointillé)"),
         x=NULL, y="dBm (plus proche de 0 = meilleur)")
}
```

**Lecture rapide – RSRP (p50).**  
Le niveau RSRP structure la performance radio. En-dessous d’environ **−100 dBm**, les débits chutent et la variabilité augmente. Aligner les poches < −100 dBm sur **`r env_top`** (optimisation tilt/puissance/PCI, densification ciblée) stabilise DL/UL.
