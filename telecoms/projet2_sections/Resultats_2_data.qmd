
---
title: "Résultats – Data (Internet mobile)"
subtitle: "Pass 5s/10s pondérés & radio (RSRP/RSCP) — rendu exécutif, sans code visible"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: false
    code-fold: false
    code-tools: false
execute:
  echo: false
  warning: false
  message: false
---

## Préparation (rappel)

Les indicateurs exploités : **pass \< 5 s**, **pass \< 10 s** (pondérés par `base_val`) et **RSRP/RSCP** (médianes & IQR, dBm : plus proche de 0 = meilleur).  
Les résultats sont consolidés **par opérateur**, tous environnements confondus.

::: {.callout-tip}
**Lecture métier.**  
- *Pass \< 5 s* : expérience instantanée perçue.  
- *Pass \< 10 s* : robustesse générale de chargement.  
- *RSRP/RSCP* : qualité radio sous-jacente ; viser médiane ≥ −100 dBm et IQR serré.
:::

```{r}
# ====== Préparation ultra-robuste (sans dépendances externes) ======
pal <- c("#2D6A9F","#7A9FB7","#C27D38","#6A9F58")  # palette sobre

wmean <- function(x,w){
  x <- as.numeric(x); w <- as.numeric(w)
  if (all(is.na(x))) return(NA_real_)
  if (length(w) != length(x) || all(is.na(w))) return(mean(x, na.rm = TRUE))
  stats::weighted.mean(x, w, na.rm = TRUE)
}

# Entrée attendue : data_scored_norm (créée plus tôt dans le pipeline)
has_df  <- exists("data_scored_norm") && is.data.frame(get("data_scored_norm"))
df0     <- if (has_df) get("data_scored_norm") else data.frame()
need    <- c("operateur","indicateur","valeur","base_val")
has_col <- has_df && all(need %in% names(df0))

has5     <- has_col && any(df0$indicateur=="loaded_in_less_5_secondes",  na.rm=TRUE)
has10    <- has_col && any(df0$indicateur=="loaded_in_less_10_secondes", na.rm=TRUE)
has_rsrp <- has_col && any(df0$indicateur=="rsrp",  na.rm=TRUE)
has_rscp <- has_col && any(df0$indicateur=="rscp",  na.rm=TRUE)

ops_order <- if (has_col) sort(unique(as.character(df0$operateur))) else character(0)

fallback_callout <- function(titre, precision=""){
  msg <- paste0("**", titre, "** — Indicateur non couvert dans ce périmètre de mesure. ",
                "Résultat non affiché pour préserver la lisibilité décisionnelle.",
                if(nchar(precision)) paste0(" _", precision, "_") else "")
  cat("::: {.callout-note}\n", msg, "\n:::\n", sep = "")
}
```

## Pass rate \< 5 secondes (pondéré)

Une latence initiale maîtrisée (< 5 s) traduit une **expérience instantanée** satisfaisante dans les contextes les plus exigeants (pics de charge, nœuds de trafic).

```{r}
if(!has5){
  fallback_callout("Pass < 5 s (pondéré)")
} else {
  sub <- df0[df0$indicateur=="loaded_in_less_5_secondes", c("operateur","valeur","base_val")]
  ops <- ops_order; pct <- numeric(length(ops))
  for(i in seq_along(ops)){
    s <- sub[sub$operateur==ops[i],]
    pct[i] <- 100 * wmean(s$valeur, ifelse(is.na(s$base_val), 1, s$base_val))
  }
  ord <- order(pct, decreasing=TRUE); ops<-ops[ord]; pct<-pct[ord]
  oldpar <- par(no.readonly=TRUE); on.exit(par(oldpar), add=TRUE)
  par(mar=c(6,4,2,1))
  bp <- barplot(pct, names.arg=ops, las=2, col=pal[1],
                ylim=c(0, max(5, pct, na.rm=TRUE)*1.12),
                ylab="% de succès", main="Pass < 5 s (pondéré)")
  text(bp, pct, labels=sprintf("%.1f%%", pct), pos=3, cex=.9)
}
```

::: {.callout-note}
**Lecture métier.** Le *pass \< 5 s* reflète l’instantané client. Un écart \> 5 pts devient perceptible.  
**Action.** Sécuriser les 5 s sur zones denses (gares, carrefours, centres commerciaux).
:::

## Pass rate \< 10 secondes (pondéré)

À 10 s, **la plupart des contenus finissent par charger** ; les écarts résiduels signalent des goulots de capacité/couverture.

```{r}
if(!has10){
  fallback_callout("Pass < 10 s (pondéré)")
} else {
  sub <- df0[df0$indicateur=="loaded_in_less_10_secondes", c("operateur","valeur","base_val")]
  ops <- ops_order; pct <- numeric(length(ops))
  for(i in seq_along(ops)){
    s <- sub[sub$operateur==ops[i],]
    pct[i] <- 100 * wmean(s$valeur, ifelse(is.na(s$base_val), 1, s$base_val))
  }
  ord <- order(pct, decreasing=TRUE); ops<-ops[ord]; pct<-pct[ord]
  oldpar <- par(no.readonly=TRUE); on.exit(par(oldpar), add=TRUE)
  par(mar=c(6,4,2,1))
  bp <- barplot(pct, names.arg=ops, las=2, col=pal[2],
                ylim=c(0, max(5, pct, na.rm=TRUE)*1.12),
                ylab="% de succès", main="Pass < 10 s (pondéré)")
  text(bp, pct, labels=sprintf("%.1f%%", pct), pos=3, cex=.9)
}
```

::: {.callout-note}
**Cible.** \> 90 % sur les axes à fort trafic (ferroviaire/routier) avec pilotage heures pleines.
:::

## Qualité radio — Médiane & IQR (RSRP / RSCP)

Un plan radio solide soutient la QoE data : viser **médiane ≥ −100 dBm** et **IQR serré** (dispersion faible).

```{r}
if(!(has_rsrp || has_rscp)){
  fallback_callout("Radio (RSRP/RSCP — médiane & IQR)")
} else {
  do_box <- function(indic, col){
    sub <- df0[df0$indicateur==indic, c("operateur","valeur")]
    ops <- ops_order
    med <- p25 <- p75 <- rep(NA_real_, length(ops))
    for(i in seq_along(ops)){
      v <- sub$valeur[sub$operateur==ops[i]]
      v <- v[is.finite(v)]
      if(length(v)>0){
        med[i] <- as.numeric(stats::quantile(v,.50,na.rm=TRUE))
        p25[i] <- as.numeric(stats::quantile(v,.25,na.rm=TRUE))
        p75[i] <- as.numeric(stats::quantile(v,.75,na.rm=TRUE))
      }
    }
    ord <- order(med, decreasing=FALSE)  # plus proche de 0 = meilleur
    ops<-ops[ord]; med<-med[ord]; p25<-p25[ord]; p75<-p75[ord]
    oldpar <- par(no.readonly=TRUE); on.exit(par(oldpar), add=TRUE)
    par(mar=c(6,4,2,1))
    plot(seq_along(ops), med, xaxt="n", xlab="", ylab="dBm (plus proche de 0 = meilleur)",
         ylim=range(c(p25,p75,-100), na.rm=TRUE)*1.0,
         pch=19, col=col, main=paste(toupper(indic), "— médiane & IQR"))
    axis(1, at=seq_along(ops), labels=ops, las=2, cex.axis=.9)
    segments(x0=seq_along(ops), y0=p25, x1=seq_along(ops), y1=p75, lwd=6, col=adjustcolor(col,.5))
    abline(h=-100, lty=2)
    text(seq_along(ops), med, labels=round(med,0), pos=3, cex=.8)
  }
  if (has_rsrp) do_box("rsrp", pal[3])
  if (has_rscp) do_box("rscp", pal[4])
}
```

::: {.callout-note}
**Actions.** Réduire les queues \< −110 dBm sur les couloirs ferroviaires via petites cellules / réglages paramétriques.
:::

## Synthèse analytique & recommandations

- **Expérience immédiate (5 s)** : viser 85–90 %+ en zones denses ; traiter les poches sous-seuil via **dimensionnement PRB/layering** & **optim radio**.  
- **Robustesse (10 s)** : au-delà de 90 %, les irritants restants sont **localisés** ; plan d’actions ciblé par **corridors** (TGV/RER/autoroutes).  
- **Radio** : sécuriser une **médiane ≥ −100 dBm** et **resserrer l’IQR** ; chasse aux \< −110 dBm avec boucle **mesure → optimisation → re-mesure**.

::: {.callout-tip}
**Conclusion.** Performances élevées, mais **variabilité par contexte** (mobilité vs habitat).  
Un pilotage mensuel des **pass-rates pondérés** et des **médianes radio** aligne QoE et investissements.
:::

