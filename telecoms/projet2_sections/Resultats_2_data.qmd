
---
title: "Résultats – Data (Internet mobile)"
subtitle: "Pass 5s/10s pondérés & radio (RSRP/RSCP) — rendu exécutif, sans code visible"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: false
    theme: cosmo
    code-fold: false
    smooth-scroll: true
execute:
  echo: false
  warning: false
  message: false
fontsize: 1.03em
---

```{r setup}
suppressPackageStartupMessages({
  library(dplyr); library(ggplot2); library(forcats); library(tidyr); library(scales)
})

# ====== Source de vérité ======
df0 <- NULL
if (exists("data_scored_norm")) df0 <- data_scored_norm
else if (exists("data_scored_clean")) df0 <- data_scored_clean
else if (exists("data_scored")) df0 <- data_scored

has_data <- is.data.frame(df0) && all(c("operateur","indicateur","valeur") %in% names(df0))

# Helpers
wmean <- function(x,w){ if (all(is.na(w))) w <- rep(1,length(x)); stats::weighted.mean(x, w, na.rm=TRUE) }
nz <- function(x) ifelse(is.finite(x), x, NA_real_)

# Palette sobre (alignée Voix)
pal <- c("#2A9D8F","#8E7CC3","#E76F51","#2F4858") # teal, lavande, corail, bleu sombre
names(pal) <- NULL

# Vérifs présence des indicateurs
has_pass5  <- has_data && any(df0$indicateur == "loaded_in_less_5_secondes",  na.rm=TRUE)
has_pass10 <- has_data && any(df0$indicateur == "loaded_in_less_10_secondes", na.rm=TRUE)
has_rsrp   <- has_data && any(df0$indicateur == "rsrp",  na.rm=TRUE)
has_rscp   <- has_data && any(df0$indicateur == "rscp",  na.rm=TRUE)

# base_val de secours = 1
if (has_data && !"base_val" %in% names(df0)) df0$base_val <- 1

# ordre opérateurs (par pass10 décroissant si possible, sinon alpha)
if (has_data){
  ord <- df0 %>%
    filter(indicateur=="loaded_in_less_10_secondes") %>%
    group_by(operateur) %>%
    summarise(p = wmean(valeur, base_val), .groups="drop") %>%
    arrange(desc(p)) %>% pull(operateur)
  if (length(ord)==0) ord <- sort(unique(df0$operateur))
  df0$operateur <- factor(df0$operateur, levels = ord)
}

theme_set(theme_minimal(base_size = 14))
update_geom_defaults("col", list(fill = pal[1]))
```

## Préparation (rappel)

Les indicateurs utilisés : **pass rate < 5 s**, **pass rate < 10 s** (pondérés par `base_val`) et **RSRP/RSCP** (médianes & IQR, en dBm : plus proche de 0 = meilleur).  
Les résultats sont consolidés **par opérateur**, tous environnements confondus (les coupes par environnement sont possibles en annexe/itérations futures).

---

## Pass rate < 5 secondes (pondéré)

```{r pass5_plot, fig.width=8.8, fig.height=4.8}
if (!has_data || !has_pass5){
  cat("> *Section sautée (indicateur `loaded_in_less_5_secondes` absent).*")
} else {
  p5 <- df0 %>%
    filter(indicateur=="loaded_in_less_5_secondes") %>%
    group_by(operateur) %>%
    summarise(p = 100*wmean(valeur, base_val), .groups="drop") %>%
    mutate(lbl = sprintf("%.1f%%", p))
  
  ggplot(p5, aes(operateur, p)) +
    geom_col(fill = pal[1]) +
    geom_text(aes(label = lbl), vjust = -0.25, size = 4) +
    expand_limits(y = max(p5$p, na.rm=TRUE) * 1.12) +
    labs(title = "Part des chargements < 5 s (pondéré)",
         x = NULL, y = "% de succès") +
    theme(panel.grid.minor = element_blank(),
          axis.text.x = element_text(face="bold"))
}
```

::: callout-note
**Lecture métier.** Le **pass < 5 s** reflète l’expérience “quasi instantanée”. Des écarts > 5 pts entre opérateurs sont **perceptibles** côté client (apps, réseaux sociaux, e-commerce).  
**Priorité** : sécuriser le 5s sur les zones à forte demande (gares, carrefours routiers, centres commerciaux).
:::

---

## Pass rate < 10 secondes (pondéré)

```{r pass10_plot, fig.width=8.8, fig.height=4.8}
if (!has_data || !has_pass10){
  cat("> *Section sautée (indicateur `loaded_in_less_10_secondes` absent).*")
} else {
  p10 <- df0 %>%
    filter(indicateur=="loaded_in_less_10_secondes") %>%
    group_by(operateur) %>%
    summarise(p = 100*wmean(valeur, base_val), .groups="drop") %>%
    mutate(lbl = sprintf("%.1f%%", p))
  
  ggplot(p10, aes(operateur, p)) +
    geom_col(fill = pal[3]) +
    geom_text(aes(label = lbl), vjust = -0.25, size = 4) +
    expand_limits(y = max(p10$p, na.rm=TRUE) * 1.12) +
    labs(title = "Part des chargements < 10 s (pondéré)",
         x = NULL, y = "% de succès") +
    theme(panel.grid.minor = element_blank(),
          axis.text.x = element_text(face="bold"))
}
```

::: callout-note
**Lecture métier.** À **10 s**, la majorité des contenus finissent par charger ; des écarts résiduels signalent des **goulots de capacité** ou de **couverture**.  
**Action** : viser un **taux > 90 %** sur les axes à fort trafic (ferroviaire/routier) avec un pilotage par **heures pleines**.
:::

---

## Qualité radio — Médiane & IQR (RSRP / RSCP)

```{r radio_plot, fig.width=9.2, fig.height=5.2}
has_radio <- has_data && (has_rsrp || has_rscp)
if (!has_radio){
  cat("> *Section sautée (indicateurs `rsrp`/`rscp` absents).*")
} else {
  radio <- df0 %>%
    filter(indicateur %in% c("rsrp","rscp")) %>%
    group_by(operateur, indicateur) %>%
    summarise(
      med = median(valeur, na.rm = TRUE),
      p25 = quantile(valeur, .25, na.rm = TRUE),
      p75 = quantile(valeur, .75, na.rm = TRUE),
      .groups="drop"
    ) %>%
    mutate(indicateur = factor(indicateur, levels=c("rsrp","rscp"),
                               labels=c("RSRP (4G/5G)","RSCP (3G)")))
  
  ggplot(radio, aes(operateur, med, color = indicateur)) +
    geom_point(size = 3) +
    geom_errorbar(aes(ymin = p25, ymax = p75), width = .2, linewidth = 1) +
    scale_color_manual(values = pal[c(4,2)]) +
    geom_hline(yintercept = -100, linetype = "dashed", color = "grey40") +
    labs(title = "Radio – médiane & IQR (dBm, plus proche de 0 = meilleur)",
         x = NULL, y = "dBm", color = "Technologie") +
    theme(panel.grid.minor = element_blank(),
          axis.text.x = element_text(face="bold"))
}
```

::: callout-note
**Lecture métier.** Une médiane **au-dessus de −100 dBm** avec un **IQR serré** garantit des sessions stables (moins de ré-essais, meilleure QoE streaming).  
**Cibles** : limiter les queues < −110 dBm sur les couloirs ferroviaires et zones denses en **petites cellules** ou **tilt/param**.
:::

---

## Tableau récapitulatif (métriques clés)

```{r recap_table}
if (!has_data){
  cat("> *Section sautée (pas de données).*")
} else {
  # KPIs
  p5  <- if (has_pass5)  df0 |> filter(indicateur=="loaded_in_less_5_secondes")  |> group_by(operateur) |> summarise(v=100*wmean(valeur,base_val),.groups="drop") else NULL
  p10 <- if (has_pass10) df0 |> filter(indicateur=="loaded_in_less_10_secondes") |> group_by(operateur) |> summarise(v=100*wmean(valeur,base_val),.groups="drop") else NULL
  rrp <- if (has_rsrp)   df0 |> filter(indicateur=="rsrp") |> group_by(operateur) |> summarise(v=median(valeur,na.rm=TRUE),.groups="drop") else NULL
  rcp <- if (has_rscp)   df0 |> filter(indicateur=="rscp") |> group_by(operateur) |> summarise(v=median(valeur,na.rm=TRUE),.groups="drop") else NULL
  
  best <- function(tbl, higher=TRUE, fmt=function(x)x){
    if (is.null(tbl)) return(NA_character_)
    i <- if (higher) which.max(tbl$v) else which.max(-tbl$v)
    sprintf("%s (%s)", as.character(tbl$operateur[i]), if (is.finite(tbl$v[i])) fmt(tbl$v[i]) else "NA")
  }
  gap  <- function(tbl, higher=TRUE, fmt=function(x)x){
    if (is.null(tbl)) return(NA_character_)
    rng <- range(tbl$v, na.rm=TRUE)
    if (!all(is.finite(rng))) return(NA_character_)
    fmt(rng[2] - rng[1])
  }
  pct <- function(x) sprintf("%.1f%%", x)
  dbm <- function(x) sprintf("%.0f dBm", x)
  
  recap <- tibble::tibble(
    Indicateur = c("Pass < 5 s (pondéré)","Pass < 10 s (pondéré)","RSRP médiane","RSCP médiane"),
    `Meilleur opérateur` = c(best(p5, TRUE, pct), best(p10, TRUE, pct), best(rrp, FALSE, dbm), best(rcp, FALSE, dbm)),
    `Écart max`          = c(gap(p5, TRUE, pct), gap(p10, TRUE, pct), gap(rrp, FALSE, dbm), gap(rcp, FALSE, dbm))
  )
  knitr::kable(recap, align="lcc")
}
```

---

## Synthèse analytique & recommandations

- **Expérience immédiate (5 s)** : viser la parité **> 85–90 %** sur les zones à forte densité ; traiter les poches en dessous du seuil via **dimensionnement** (PRB/Layering) et **optimisation radio**.
- **Robustesse (10 s)** : au-delà de 90 %, les irritants restants sont **localisés** ; plan d’actions par **corridors** (TGV, RER, autoroutes).
- **Radio** : sécuriser une médiane **≥ −100 dBm** et resserrer l’IQR ; surveiller les zones < −110 dBm avec une boucle **mesure → optimisation → re-mesure**.

::: callout-tip
**Conclusion.** Marché globalement performant, mais **variabilité par contexte** (mobilité vs habitat). Le pilotage mensuel des **pass-rates pondérés** et des **médianes radio** permet d’orienter rapidement les investissements et de suivre l’impact **QoE**.
:::

