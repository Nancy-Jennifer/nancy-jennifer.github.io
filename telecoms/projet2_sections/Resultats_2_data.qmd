
## 2) Résultats DATA — vitesses & radio (p50)

**Pourquoi ces 3 KPI ?**  
- **Débit descendant (DL)** = ressenti principal côté utilisateur (web/vidéo).  
- **Débit montant (UL)** = usages messagerie, réseaux sociaux, envoi média.  
- **RSRP (dBm)** = cause physique (qualité radio) → explique les écarts.

::: {.callout-note}
**Lecture métier (30 s)**  
- L’**habitat** reste élevé en DL/UL ; la **mobilité** introduit plus de dispersion.  
- Le **RSRP** médian structure la performance DL/UL : radio faible → DL/UL dégradés.  
- Priorités 2024 : lisser la cohérence en mobilité (axes ferroviaires/routiers).
:::

```{r deps-data, include=FALSE}
# Dépendances chargées sans installation (install déjà fait dans 0-deps du projet)
suppressPackageStartupMessages({
  library(dplyr); library(stringr); library(forcats)
  library(tidyr); library(ggplot2); library(readr); library(knitr)
})
```

```{r data-ensure-norm, message=FALSE, warning=FALSE}
# On cherche un objet prêt (ordre de préférence)
if (exists("data_scored_norm")) {
  df <- data_scored_norm
} else if (exists("data_scored_clean")) {
  df <- data_scored_clean
} else if (exists("data_scored")) {
  df <- data_scored
} else {
  stop("Aucun des objets {data_scored_norm, data_scored_clean, data_scored} n'est disponible. 
       Exécute d'abord les chunks EDA Data que tu viens d'envoyer (jusqu'à data_scored_norm).")
}

# Colonnes minimales attendues
req <- c("operateur","lieu_strate","indicateur","kpi","valeur")
miss <- setdiff(req, names(df))
if (length(miss)) stop("Colonnes manquantes: ", paste(miss, collapse=", "))

# Normalisation légère (noms opérateurs + env)
df <- df %>%
  mutate(
    operateur  = str_to_title(as.character(operateur)),
    env        = recode(str_to_lower(as.character(lieu_strate)),
                        "habitat"="Habitat","mobilite"="Mobilité",
                        .default = str_to_title(as.character(lieu_strate))),
    indic_l    = str_to_lower(as.character(indicateur)),
    kpi_l      = str_to_lower(as.character(kpi))
  )

# Classification robuste des familles (supporte tes libellés FR/EN et dérivés)
famille_of <- function(ind_l, kpi_l){
  case_when(
    str_detect(ind_l, "descend|download|\\bdl\\b|down|mbps|throughput") |
      str_detect(kpi_l, "descend|download|\\bdl\\b|down|mbps|throughput") ~ "debit_down",
    str_detect(ind_l, "montant|upload|\\bul\\b|up") |
      str_detect(kpi_l, "montant|upload|\\bul\\b|up")                     ~ "debit_up",
    str_detect(ind_l, "^rsrp$") | str_detect(kpi_l, "^rsrp$")             ~ "rsrp",
    TRUE ~ "autres"
  )
}

df <- df %>% mutate(famille = famille_of(indic_l, kpi_l))
```

```{r kpi-median-core, message=FALSE, warning=FALSE}
# KPI centraux (médianes p50)
kpi_core <- df %>%
  filter(famille %in% c("debit_down","debit_up","rsrp")) %>%
  group_by(operateur, env, famille) %>%
  summarise(
    median_val = suppressWarnings(stats::median(valeur, na.rm = TRUE)),
    n_meas     = sum(!is.na(valeur)),
    .groups="drop"
  ) %>%
  tidyr::pivot_wider(
    names_from = famille,
    values_from = c(median_val, n_meas),
    names_sep = "__"
  ) %>%
  arrange(env, desc(median_val__debit_down))

# Tableau (sans gt)
knitr::kable(
  kpi_core,
  caption = "KPI DATA — médianes (p50) par opérateur & environnement",
  digits = 1,
  align = "lcccccc"
)
```

```{r plot-dl, message=FALSE, warning=FALSE}
dl_tbl <- df %>%
  filter(famille == "debit_down") %>%
  group_by(operateur, env) %>%
  summarise(dl_med_mbps = median(valeur, na.rm = TRUE), .groups="drop")

p_dl <- ggplot(dl_tbl, aes(x = fct_reorder(operateur, dl_med_mbps),
                           y = dl_med_mbps, fill = env)) +
  geom_col(width = .65, position = position_dodge(width = .7)) +
  coord_flip() +
  facet_wrap(~ env, nrow = 1, scales = "free_y") +
  labs(x = NULL, y = "Débit descendant médian (Mb/s)",
       title = "Débit descendant — p50 par opérateur",
       subtitle = "Lecture : plus haut = navigation/streaming plus fluide") +
  theme_minimal(base_size = 12)
p_dl
```

```{r plot-ul, message=FALSE, warning=FALSE}
ul_tbl <- df %>%
  filter(famille == "debit_up") %>%
  group_by(operateur, env) %>%
  summarise(ul_med_mbps = median(valeur, na.rm = TRUE), .groups="drop")

p_ul <- ggplot(ul_tbl, aes(x = fct_reorder(operateur, ul_med_mbps),
                           y = ul_med_mbps, fill = env)) +
  geom_col(width = .65, position = position_dodge(width = .7)) +
  coord_flip() +
  facet_wrap(~ env, nrow = 1, scales = "free_y") +
  labs(x = NULL, y = "Débit montant médian (Mb/s)",
       title = "Débit montant — p50 par opérateur",
       subtitle = "Lecture : UL impacte envoi médias, cloud, messageries") +
  theme_minimal(base_size = 12)
p_ul
```

```{r plot-rsrp, message=FALSE, warning=FALSE}
rsrp_tbl <- df %>%
  filter(famille == "rsrp") %>%
  group_by(operateur, env) %>%
  summarise(rsrp_med_dbm = median(valeur, na.rm = TRUE), .groups="drop")

p_rsrp <- ggplot(rsrp_tbl, aes(x = fct_reorder(operateur, rsrp_med_dbm),
                               y = rsrp_med_dbm, fill = env)) +
  geom_col(width = .65, position = position_dodge(width = .7)) +
  coord_flip() +
  facet_wrap(~ env, nrow = 1, scales = "free_y") +
  geom_hline(yintercept = -100, linetype = "dashed") +
  labs(x = NULL, y = "RSRP médian (dBm)",
       title = "Qualité radio (RSRP) — p50 par opérateur",
       subtitle = "Repère : -100 dBm (ligne pointillée) ≈ seuil de confort 4G") +
  theme_minimal(base_size = 12)
p_rsrp
```

```{r exports-data, message=FALSE, warning=FALSE}
# Exports (CSV + PNG) pour slides & repo
dir.create("outputs/kpi", recursive = TRUE, showWarnings = FALSE)
dir.create("outputs/img", recursive = TRUE, showWarnings = FALSE)

readr::write_csv(kpi_core, "outputs/kpi/data_kpi_core_p50.csv")
readr::write_csv(dl_tbl,   "outputs/kpi/data_dl_p50.csv")
readr::write_csv(ul_tbl,   "outputs/kpi/data_ul_p50.csv")
readr::write_csv(rsrp_tbl, "outputs/kpi/data_rsrp_p50.csv")

ggplot2::ggsave("outputs/img/data_dl_p50.png",   p_dl,   width = 9, height = 4.2, dpi = 200)
ggplot2::ggsave("outputs/img/data_ul_p50.png",   p_ul,   width = 9, height = 4.2, dpi = 200)
ggplot2::ggsave("outputs/img/data_rsrp_p50.png", p_rsrp, width = 9, height = 4.2, dpi = 200)
```

::: {.callout-tip}
**À présenter à l’oral (30–45 s)**  
1) **DL p50** classe l’expérience perçue.  
2) **UL p50** différencie messagerie/partage.  
3) **RSRP p50** explique les cas de DL/UL faibles : si **RSRP** < ~-100 dBm, cohérence à traiter.
:::

