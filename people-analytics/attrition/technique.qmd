---
title: "Notebook technique ‚Äì IBM HR Attrition"
subtitle: "Pr√©paration des donn√©es & g√©n√©ration des figures EDA (H1 √† H6)"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: true
execute:
  echo: true
  warning: false
  message: false
---

## Contexte & objectif technique

Ce document reprend la logique du notebook Python initial :

- importation & pr√©paration du dataset **IBM HR Attrition**,
- renommage des variables en fran√ßais,
- g√©n√©ration des figures correspondant aux **6 hypoth√®ses People Analytics**,
- **sauvegarde syst√©matique en PNG** dans `assets/people-analytics/figures/` pour int√©gration dans `eda_resultats.qmd`.

Aucune interpr√©tation m√©tier n‚Äôest donn√©e ici : on se concentre uniquement sur les **d√©cisions techniques**.

## Import des biblioth√®ques & configuration

```{python}
import os
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

plt.style.use("default")
plt.rcParams["figure.figsize"] = (8, 5)

def find_repo_root(start_dir: str) -> str:
    """
    Remonte l'arborescence √† partir de start_dir pour trouver la racine du projet
    (rep√©r√©e par la pr√©sence de _quarto.yml). Retourne start_dir si non trouv√©.
    """
    current = os.path.abspath(start_dir)
    while True:
        if os.path.exists(os.path.join(current, "_quarto.yml")):
            return current
        parent = os.path.dirname(current)
        if parent == current:
            return os.path.abspath(start_dir)
        current = parent

REPO_ROOT = find_repo_root(os.getcwd())

DATA_PATH = os.path.join(
    REPO_ROOT, "people-analytics", "data", "WA_Fn-UseC_-HR-Employee-Attrition.csv"
)

OUTPUT_DIR = os.path.join(
    REPO_ROOT, "assets", "people-analytics", "figures"
)
os.makedirs(OUTPUT_DIR, exist_ok=True)

print("REPO_ROOT :", REPO_ROOT)
print("DATA_PATH :", DATA_PATH)
print("OUTPUT_DIR:", OUTPUT_DIR)
print("CSV existe ?", os.path.exists(DATA_PATH))
```

## Chargement du jeu de donn√©es

```{python}
if not os.path.exists(DATA_PATH):
    raise FileNotFoundError(
        "CSV introuvable au chemin attendu.\n"
        f"Chemin test√© : {DATA_PATH}\n"
        "üëâ V√©rifie qu'il est bien versionn√© dans le repo (people-analytics/data/) "
        "et relance le rendu."
    )

df = pd.read_csv(DATA_PATH)
df.head()
```

## Renommage des variables (version fran√ßaise)

```{python}
colonnes_renommees = {
    "Attrition": "D√©part",
    "BusinessTravel": "D√©placements professionnels",
    "Age": "√Çge",
    "Department": "D√©partement",
    "MonthlyIncome": "Salaire mensuel",
    "EducationField": "Domaine d‚Äô√©tudes",
    "TotalWorkingYears": "Ann√©es de carri√®re",
    "Gender": "Sexe",
    "YearsAtCompany": "Anciennet√© dans l‚Äôentreprise",
    "JobRole": "Poste",
    "JobSatisfaction": "Satisfaction au travail",
    "MaritalStatus": "√âtat civil",
    "EnvironmentSatisfaction": "Satisfaction environnement",
    "OverTime": "Heures suppl√©mentaires",
    "WorkLifeBalance": "√âquilibre vie pro/perso",
    "DistanceFromHome": "Distance domicile-travail",
}

df = df.rename(columns=colonnes_renommees)

# garde-fou: on v√©rifie que les colonnes critiques existent bien
required_cols = [
    "D√©part",
    "Satisfaction au travail",
    "Anciennet√© dans l‚Äôentreprise",
    "Distance domicile-travail",
    "Heures suppl√©mentaires",
    "Poste",
]
missing = [c for c in required_cols if c not in df.columns]
if missing:
    raise ValueError(f"Colonnes manquantes apr√®s renommage: {missing}")

print("‚úÖ Colonnes critiques OK.")
```

## V√©rifications rapides (types & valeurs)

```{python}
df.info()
```

```{python}
df["D√©part"].value_counts()
```

---

## Figures pour l‚ÄôEDA (H1 √† H6)

Chaque sous-section :
1) g√©n√®re un graphique cl√©,
2) l‚Äôaffiche dans le rendu,
3) et l‚Äôenregistre en PNG dans `assets/people-analytics/figures/`.

### H1 ‚Äì Satisfaction au travail √ó D√©part

```{python}
table_h1 = pd.crosstab(
    df["Satisfaction au travail"],
    df["D√©part"],
    normalize="index"
)
table_h1
```

```{python}
fig, ax = plt.subplots()

bottom = np.zeros(len(table_h1))
x = np.arange(len(table_h1.index))

for status in table_h1.columns:
    ax.bar(x, table_h1[status].values, bottom=bottom, label=status)
    bottom += table_h1[status].values

ax.set_title("R√©partition des d√©parts selon la satisfaction au travail")
ax.set_xlabel("Satisfaction au travail (1 = tr√®s faible, 4 = tr√®s √©lev√©e)")
ax.set_ylabel("Proportion d'employ√©s")
ax.set_xticks(x)
ax.set_xticklabels(table_h1.index)
ax.legend(title="D√©part")
ax.grid(axis="y", alpha=0.3)

fig_path_h1 = os.path.join(OUTPUT_DIR, "H1_satisfaction_depart.png")
fig.savefig(fig_path_h1, dpi=300, bbox_inches="tight")
plt.show()
plt.close(fig)

print("‚úÖ Figure H1 sauvegard√©e :", fig_path_h1)
```

### H2 ‚Äì Anciennet√© dans l‚Äôentreprise √ó D√©part

```{python}
col_anciennete = "Anciennet√© dans l‚Äôentreprise"

# Ordre stable (pour √©viter que Yes/No change selon l'environnement)
order_depart = ["Yes", "No"]
present = [c for c in order_depart if c in df["D√©part"].unique()]
if len(present) != len(order_depart):
    present = list(df["D√©part"].unique())

data_h2 = [df.loc[df["D√©part"] == cat, col_anciennete].dropna() for cat in present]

fig, ax = plt.subplots()
ax.boxplot(data_h2, labels=present, showfliers=True)

ax.set_title("Anciennet√© dans l‚Äôentreprise selon le statut de d√©part")
ax.set_xlabel("D√©part de l'entreprise")
ax.set_ylabel("Anciennet√© dans l‚Äôentreprise (en ann√©es)")
ax.grid(axis="y", alpha=0.3)

fig_path_h2 = os.path.join(OUTPUT_DIR, "H2_anciennete_depart.png")
fig.savefig(fig_path_h2, dpi=300, bbox_inches="tight")
plt.show()
plt.close(fig)

print("‚úÖ Figure H2 sauvegard√©e :", fig_path_h2)
```

### H3 ‚Äì Distance domicile-travail √ó D√©part

```{python}
col_distance = "Distance domicile-travail"

fig, ax = plt.subplots()

bins = 20
for status, subset in df.groupby("D√©part"):
    ax.hist(subset[col_distance].dropna(), bins=bins, alpha=0.5, label=status)

ax.set_title("Distribution de la distance domicile-travail selon le d√©part")
ax.set_xlabel("Distance domicile-travail")
ax.set_ylabel("Nombre d‚Äôemploy√©s")
ax.legend(title="D√©part")
ax.grid(axis="y", alpha=0.3)

fig_path_h3 = os.path.join(OUTPUT_DIR, "H3_distance_depart.png")
fig.savefig(fig_path_h3, dpi=300, bbox_inches="tight")
plt.show()
plt.close(fig)

print("‚úÖ Figure H3 sauvegard√©e :", fig_path_h3)
```

### H4 ‚Äì Heures suppl√©mentaires √ó D√©part

```{python}
table_h4 = pd.crosstab(
    df["Heures suppl√©mentaires"],
    df["D√©part"],
    normalize="index"
)
table_h4
```

```{python}
fig, ax = plt.subplots()

bottom = np.zeros(len(table_h4))
x = np.arange(len(table_h4.index))

for status in table_h4.columns:
    ax.bar(x, table_h4[status].values, bottom=bottom, label=status)
    bottom += table_h4[status].values

ax.set_title("R√©partition des d√©parts selon les heures suppl√©mentaires")
ax.set_xlabel("Heures suppl√©mentaires")
ax.set_ylabel("Proportion d'employ√©s")
ax.set_xticks(x)
ax.set_xticklabels(table_h4.index)
ax.legend(title="D√©part")
ax.grid(axis="y", alpha=0.3)

fig_path_h4 = os.path.join(OUTPUT_DIR, "H4_heures_sup_depart.png")
fig.savefig(fig_path_h4, dpi=300, bbox_inches="tight")
plt.show()
plt.close(fig)

print("‚úÖ Figure H4 sauvegard√©e :", fig_path_h4)
```

### H5 ‚Äì Anciennet√© √ó Heures suppl√©mentaires

```{python}
max_anc = df[col_anciennete].max()

# garde-fou si valeurs √©tranges
max_anc = 40 if pd.isna(max_anc) else float(max_anc)
bins = [0, 3, 6, 10, max_anc]
labels = ["0-3 ans", "4-6 ans", "7-10 ans", "10+ ans"]

df["Tranche anciennet√©"] = pd.cut(
    df[col_anciennete],
    bins=bins,
    labels=labels,
    include_lowest=True
)

table_h5 = pd.crosstab(
    df["Tranche anciennet√©"],
    df["Heures suppl√©mentaires"],
    normalize="index"
) * 100

table_h5.round(1)
```

```{python}
fig, ax = plt.subplots()

bottom = np.zeros(len(table_h5))
x = np.arange(len(table_h5.index))

for hsup in table_h5.columns:
    ax.bar(x, table_h5[hsup].values, bottom=bottom, label=hsup)
    bottom += table_h5[hsup].values

ax.set_title("R√©partition des heures suppl√©mentaires par tranche d‚Äôanciennet√©")
ax.set_xlabel("Tranche d‚Äôanciennet√©")
ax.set_ylabel("Proportion d‚Äôemploy√©s (%)")
ax.set_xticks(x)
ax.set_xticklabels(table_h5.index)
ax.legend(title="Heures suppl√©mentaires")
ax.grid(axis="y", alpha=0.3)

fig_path_h5 = os.path.join(OUTPUT_DIR, "H5_anciennete_heures_sup.png")
fig.savefig(fig_path_h5, dpi=300, bbox_inches="tight")
plt.show()
plt.close(fig)

print("‚úÖ Figure H5 sauvegard√©e :", fig_path_h5)
```

### H6 ‚Äì Poste √ó D√©part (zones m√©tier √† risque)

```{python}
table_h6 = pd.crosstab(
    df["Poste"],
    df["D√©part"],
    normalize="index"
)

# On trie par taux de d√©part "Yes" si pr√©sent
if "Yes" in table_h6.columns:
    table_h6 = table_h6.sort_values("Yes", ascending=False)

table_h6.head()
```

```{python}
fig, ax = plt.subplots(figsize=(10, 6))

bottom = np.zeros(len(table_h6))
x = np.arange(len(table_h6.index))

for status in table_h6.columns:
    ax.bar(x, table_h6[status].values, bottom=bottom, label=status)
    bottom += table_h6[status].values

ax.set_title("Taux de d√©part par poste (barres empil√©es)")
ax.set_xlabel("Poste")
ax.set_ylabel("Proportion d'employ√©s")
ax.set_xticks(x)
ax.set_xticklabels(table_h6.index, rotation=45, ha="right")
ax.legend(title="D√©part")
ax.grid(axis="y", alpha=0.3)

fig_path_h6_bar = os.path.join(OUTPUT_DIR, "H6_poste_depart_barres.png")
fig.savefig(fig_path_h6_bar, dpi=300, bbox_inches="tight")
plt.show()
plt.close(fig)

print("‚úÖ Figure H6 (barres) sauvegard√©e :", fig_path_h6_bar)
```

```{python}
# Heatmap "maison" (sans seaborn)
heatmap_data = table_h6.copy()

fig, ax = plt.subplots(figsize=(10, 6))
im = ax.imshow(heatmap_data.values, aspect="auto")

ax.set_xticks(np.arange(len(heatmap_data.columns)))
ax.set_yticks(np.arange(len(heatmap_data.index)))
ax.set_xticklabels(heatmap_data.columns)
ax.set_yticklabels(heatmap_data.index)
plt.setp(ax.get_yticklabels(), rotation=45, ha="right")

ax.set_title("Taux de d√©part par poste (heatmap)")
ax.set_xlabel("D√©part")
ax.set_ylabel("Poste")

for i in range(heatmap_data.shape[0]):
    for j in range(heatmap_data.shape[1]):
        value = heatmap_data.values[i, j]
        ax.text(
            j, i, f"{value:.2f}",
            ha="center", va="center",
            color="white" if value > 0.5 else "black",
            fontsize=8
        )

fig.colorbar(im, ax=ax, fraction=0.046, pad=0.04)

fig_path_h6_hm = os.path.join(OUTPUT_DIR, "H6_poste_depart_heatmap.png")
fig.savefig(fig_path_h6_hm, dpi=300, bbox_inches="tight")
plt.show()
plt.close(fig)

print("‚úÖ Figure H6 (heatmap) sauvegard√©e :", fig_path_h6_hm)
```

## R√©capitulatif des figures g√©n√©r√©es

```{python}
files = sorted(f for f in os.listdir(OUTPUT_DIR) if f.lower().endswith(".png"))
files
```
